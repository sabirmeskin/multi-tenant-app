#!/usr/bin/env php
<?php

echo "Creating demo tenant with proper data...\n";

if (file_exists(__DIR__ . '/vendor/autoload.php')) {
    require __DIR__ . '/vendor/autoload.php';
} else {
    echo "Error: Could not find vendor/autoload.php\n";
    exit(1);
}

$app = require_once __DIR__ . '/bootstrap/app.php';
$kernel = $app->make(Illuminate\Contracts\Console\Kernel::class);
$kernel->bootstrap();

$Domain = config('tenancy.domain_model');

// Create tenant with proper data field
$tenant = new Stancl\Tenancy\Database\Models\Tenant();
$tenant->id = \Illuminate\Support\Str::uuid()->toString();
$tenant->data = json_encode(['name' => 'Demo Tenant']); // Store as JSON
$tenant->save();

echo "✓ Tenant created: {$tenant->id}\n";

// Create domain
$domain = new $Domain();
$domain->domain = 'demo.localhost';
$domain->tenant_id = $tenant->id;
$domain->save();

echo "✓ Domain created: demo.localhost\n";

// Run migrations
Illuminate\Support\Facades\Artisan::call('tenants:migrate', ['--tenants' => [$tenant->id]]);
echo "✓ Migrations completed\n";

// Insert test data
$tenant->run(function () use ($tenant) {
    Illuminate\Support\Facades\DB::table('test_data')->insert([
        'message' => 'Welcome to Demo Tenant!',
        'tenant_identifier' => $tenant->id,
        'created_at' => now(),
        'updated_at' => now(),
    ]);
});

echo "✓ Test data inserted\n";
echo "\n";
echo "SUCCESS! Tenant is ready.\n";
echo "Refresh http://localhost:8000/admin/tenants to see it!\n";
echo "Test connection: http://demo.localhost:8000/test-connection\n";
